name: Deploy

on:
  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            set -o pipefail

            APP_DIR="${VPS_APP_DIR:-$HOME/metaverse}"
            cd "$APP_DIR"

            echo "=========================================="
            echo "Starting Metaverse deployment"
            echo "=========================================="

            # ---------- Load shell ----------
            [ -f "$HOME/.bashrc" ] && source "$HOME/.bashrc" || true

            # ---------- Git Pull ----------
            git fetch origin
            git checkout main
            git reset --hard origin/main
            git pull origin main

            # ---------- Env ----------
            if [ ! -f "packages/config/.env" ]; then
              echo "packages/config/.env not found"
              exit 1
            fi

            # ---------- Node + npm (FOR PM2 ONLY) ----------
            if ! command -v node >/dev/null 2>&1; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            echo "Node: $(node --version)"
            echo "npm: $(npm --version)"

            # ---------- PM2 (FORCE INSTALL) ----------
            echo "Installing PM2..."
            sudo npm install -g pm2

            echo "PM2 version:"
            pm2 --version

            # ---------- Bun ----------
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            if ! command -v bun >/dev/null 2>&1; then
              curl -fsSL https://bun.sh/install | bash
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi

            echo "Bun: $(bun --version)"

            # ---------- System Deps (Pix for Mediasoup build) ----------
            echo "Installing system dependencies..."
            # Prevent interactive prompts during apt install
            export DEBIAN_FRONTEND=noninteractive
            sudo apt-get update || true
            sudo apt-get install -y python3-pip build-essential || true

            # ---------- Stop PM2 (Fix for ETXTBSY) ----------
            echo "Stopping PM2 to release file locks..."
            # We stop to ensure binary files aren't locked during npm rebuild
            pm2 stop metaverse-client metaverse-server || true

            # ---------- Install deps ----------
            bun install

            # ---------- Rebuild Mediasoup ----------
            echo "Rebuilding Mediasoup..."
            npm rebuild mediasoup

            # ---------- Prisma ----------
            cd packages/store
            bunx prisma migrate deploy || true
            bunx prisma generate || true
            cd "$APP_DIR"

            # ---------- Build Client ----------
            cd apps/client
            bun run build
            cd "$APP_DIR"

            # ---------- Server ----------
            echo "Server is Bun-native, no build step."

            # ---------- PM2 reload ----------
            pm2 reload ecosystem.config.cjs || pm2 start ecosystem.config.cjs
            pm2 save
            pm2 status

            # ---------- Go World WS ----------
            cd apps/world
            go version
            GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o world-server
            sudo systemctl restart world
            sudo systemctl status world --no-pager
            cd "$APP_DIR"

            echo "=========================================="
            echo "Deployment completed successfully"
            echo "=========================================="
