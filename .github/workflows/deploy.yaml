name: Deploy

on:
  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            set -o pipefail

            APP_DIR="${VPS_APP_DIR:-$HOME/metaverse}"
            cd "$APP_DIR"

            echo "=========================================="
            echo "Starting Metaverse deployment"
            echo "=========================================="

            # ---------- Git Pull ----------
            echo "Fetching latest code..."
            git fetch origin
            git checkout main
            git pull origin main

            # ---------- Environment Variables ----------
            echo "Checking environment variables..."
            if [ ! -f "packages/config/.env" ]; then
              echo "packages/config/.env not found."
              exit 1
            fi

            # ---------- Bun ----------
            echo "Ensuring Bun is available..."
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            if ! command -v bun >/dev/null 2>&1; then
              curl -fsSL https://bun.sh/install | bash
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi

            echo "Bun version: $(bun --version)"

            # ---------- Install JS deps ----------
            echo "Installing dependencies..."
            bun install

            # ---------- Prisma ----------
            echo "Running Prisma migrations..."
            cd packages/store
            bunx prisma migrate deploy || echo "Prisma migrate skipped"
            bunx prisma generate || echo "Prisma generate skipped"
            cd "$APP_DIR"

            # ---------- Build Client ----------
            echo "Building client..."
            cd apps/client
            bun run build
            cd "$APP_DIR"

            # ---------- Build Server ----------
            echo "Building server..."
            cd apps/server
            bun run build || echo "Server build skipped"
            cd "$APP_DIR"

            # ---------- PM2 ----------
            echo "Checking PM2..."
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "PM2 not found on VPS. Install it once manually."
              exit 1
            fi

            echo "Reloading PM2 services..."
            pm2 reload ecosystem.config.cjs || pm2 start ecosystem.config.cjs
            pm2 save
            pm2 status

            # ==================================================
            # GO WORLD WEBSOCKET (apps/world)
            # ==================================================
            echo "Deploying Go World WebSocket..."

            cd apps/world

            echo "Go version:"
            go version

            echo "Building world-server..."
            GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o world-server

            echo "Restarting world systemd service..."
            sudo systemctl restart world

            echo "World service status:"
            sudo systemctl status world --no-pager

            cd "$APP_DIR"

            echo "=========================================="
            echo "Deployment completed successfully"
            echo "=========================================="
            echo ""
            echo "Services:"
            echo "  - Client      : PM2 (3001)"
            echo "  - API Server  : PM2 (8082)"
            echo "  - World (WS)  : systemd (8083)"
