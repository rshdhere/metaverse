name: Deploy

on:
  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            set -o pipefail

            APP_DIR="${VPS_APP_DIR:-$HOME/metaverse}"
            cd "$APP_DIR"

            echo "=========================================="
            echo "Starting Metaverse deployment"
            echo "=========================================="

            # ---------- Load shell environment ----------
            echo "Loading shell environment..."
            [ -f "$HOME/.bashrc" ] && source "$HOME/.bashrc" || true

            # ---------- Git Pull ----------
            echo "Fetching latest code..."
            git fetch origin
            git checkout main
            git pull origin main

            # ---------- Env ----------
            if [ ! -f "packages/config/.env" ]; then
              echo "packages/config/.env not found"
              exit 1
            fi

            # ---------- Bun ----------
            echo "Ensuring Bun is available..."
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            if ! command -v bun >/dev/null 2>&1; then
              curl -fsSL https://bun.sh/install | bash
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi

            echo "Bun version: $(bun --version)"

            # ---------- Install deps ----------
            echo "Installing dependencies..."
            bun install

            # ---------- Prisma ----------
            echo "Running Prisma migrations..."
            cd packages/store
            bunx prisma migrate deploy || true
            bunx prisma generate || true
            cd "$APP_DIR"

            # ---------- Build Client ----------
            echo "Building client..."
            cd apps/client
            bun run build
            cd "$APP_DIR"

            # ---------- Build Server ----------
            echo "Building server..."
            cd apps/server
            bun run build || true
            cd "$APP_DIR"

            # ---------- PM2 ----------
            echo "Reloading PM2 processes..."
            pm2 reload ecosystem.config.cjs || pm2 start ecosystem.config.cjs
            pm2 save
            pm2 status

            # ---------- Go World WS ----------
            echo "Deploying World WebSocket..."
            cd apps/world
            go version
            GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o world-server
            sudo systemctl restart world
            sudo systemctl status world --no-pager
            cd "$APP_DIR"

            echo "=========================================="
            echo "Deployment completed successfully"
            echo "=========================================="
